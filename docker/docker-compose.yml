version: "3.8"

services:
  # ================== Infrastructure ==================
  arangodb:
    image: arangodb:3.11
    container_name: zti-arangodb
    environment:
      ARANGO_ROOT_PASSWORD: ${ARANGODB_ROOT_PASSWORD:-zti_password}
    ports:
      - "8529:8529"
    volumes:
      - arangodb_data:/var/lib/arangodb3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8529/_api/version"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: zti-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    container_name: zti-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_LLM_LIBRARY=${OLLAMA_LLM_LIBRARY:-cuda_v13}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:11434/api/tags || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ================== Application Services ==================
  ingest:
    build:
      context: ../services/ingest
      dockerfile: Dockerfile
    container_name: zti-ingest
    environment:
      - ZENDESK_AGENT_URL=${ZENDESK_AGENT_URL}
      - ARANGODB_HOST=arangodb
      - QDRANT_HOST=qdrant
    depends_on:
      arangodb:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    restart: unless-stopped

  chat:
    build:
      context: ../services/chat
      dockerfile: Dockerfile
    container_name: zti-chat
    ports:
      - "8001:8001"
    environment:
      - OLLAMA_HOST=ollama
      - ARANGODB_HOST=arangodb
      - QDRANT_HOST=qdrant
    depends_on:
      - ollama
      - arangodb
      - qdrant
    restart: unless-stopped

  ui:
    build:
      context: ../services/ui
      dockerfile: Dockerfile
    container_name: zti-ui
    ports:
      - "3000:3000"
    environment:
      - CHAT_API_URL=http://chat:8001
      - ARANGODB_URL=http://arangodb:8529
    depends_on:
      - chat
      - arangodb
    restart: unless-stopped

volumes:
  arangodb_data:
  qdrant_data:
  ollama_data:

networks:
  default:
    name: zti-network

